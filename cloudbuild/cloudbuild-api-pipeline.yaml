substitutions:
  _GCS_CACHE_BUCKET: cloudbuild-m2repo

steps:
  - name: gcr.io/cloud-builders/gcloud
    id: 'env'
    entrypoint: 'bash'
    args:
      - -c
      - |

        if [[ -z "$_NAMESPACE" ]]; then
          NAMESPACE=$$(scripts/extract-namespace.sh branche $BRANCH_NAME)
        else
          NAMESPACE=$_NAMESPACE
        fi

        VERSION=$$(scripts/extract-version.sh branche $BRANCH_NAME)

        echo -e "\033[44mBranch: $BRANCH_NAME"
        echo -e "\033[44mCommit: $SHORT_SHA"
        echo -e "\033[44mEnv: $$NAMESPACE"
        echo -e "\033[44mVersion: $$VERSION"

        echo "export TAG_ENV=$$NAMESPACE" > /workspace/build.env
        echo "export TAG_VERSION=$$VERSION" >> /workspace/build.env


  # load the cache from GCS if it exists
  - name: gcr.io/cloud-builders/gsutil
    dir: /root
    entrypoint: bash
    args:
      - -c
      - |
        (
          ls -la /root/.m2
          gsutil cp gs://${PROJECT_ID}_${_GCS_CACHE_BUCKET}/m2-cache.tar.gz /tmp/m2-cache.tar.gz &&
          tar -xzf /tmp/m2-cache.tar.gz
        ) || echo 'Cache not found'
    volumes:
      - name: m2
        path: /root/.m2/
  #build service
  - name: 'maven:3.6.2-jdk-12'
    id: 'build'
    entrypoint: 'mvn'
    args: ['clean','package','-f','kpdi-api/pom.xml']
    volumes:
      - name: m2
        path: /root/.m2/
  # cache the /root/.m2 folder and upload it to GCS bucket
  - name: gcr.io/cloud-builders/gsutil
    waitFor:
      - build
    dir: /root
    entrypoint: bash
    args:
      - -c
      - |
        tar -czf /tmp/m2-cache.tar.gz .m2 &&
        gsutil cp /tmp/m2-cache.tar.gz gs://${PROJECT_ID}_${_GCS_CACHE_BUCKET}/m2-cache.tar.gz
    volumes:
      - name: m2
        path: /root/.m2/
  
  #build and push image
  - name: gcr.io/cloud-builders/docker
    id: 'build-push-image'
    waitFor:
      - env
      - build
    entrypoint: bash
    args:
        - -c
        - |
          source /workspace/build.env
          echo "Namespace: $$TAG_ENV"
          docker build -t eu.gcr.io/$PROJECT_ID/ked-pdi:$SHORT_SHA \
                       -t eu.gcr.io/$PROJECT_ID/ked-pdi:$$TAG_ENV \
                       -t eu.gcr.io/$PROJECT_ID/ked-pdi:$$TAG_VERSION \
                       -f Dockerfile .
          docker push eu.gcr.io/$PROJECT_ID/ked-pdi:$SHORT_SHA
          docker push eu.gcr.io/$PROJECT_ID/ked-pdi:$$TAG_ENV
          docker push eu.gcr.io/$PROJECT_ID/ked-pdi:$$TAG_VERSION

  #deploy
  - name: gcr.io/cloud-builders/gcloud
    id: 'deploy'
    entrypoint: bash
    args:
        - -c
        - |
          source /workspace/build.env
          gcloud run deploy $${TAG_ENV}-ked-pdi \
            --image=eu.gcr.io/$PROJECT_ID/ked-pdi:$SHORT_SHA \
            --region=europe-west1 \
            --platform=managed \
            --allow-unauthenticated \
            --memory=512M \
            --set-env-vars=GOOGLE_CLOUD_PROJECT=${PROJECT_ID},ENV=$${TAG_ENV},VERSION=$${TAG_VERSION},SHORT_SHA=${SHORT_SHA}


timeout: 9000s
tags: ['build']
options:
  substitution_option: 'ALLOW_LOOSE'
