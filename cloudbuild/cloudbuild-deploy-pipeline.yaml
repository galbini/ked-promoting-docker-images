substitutions:
  _IMAGE_TAG: ${_SHORT_SHA}

steps:
  #deploy
  - name: gcr.io/cloud-builders/gcloud
    id: 'deploy-to-cloud-run'
    entrypoint: bash
    args:
        - -c
        - |
          source /workspace/build.env
          gcloud run deploy ${_SERVICE_NAME} \
            --image=${_IMAGE_NAME}:${_IMAGE_TAG} \
            --region=europe-west1 \
            --platform=managed \
            --allow-unauthenticated \
            --memory=512M \
            --set-env-vars=GOOGLE_CLOUD_PROJECT=${PROJECT_ID},ENV=${_ENV},VERSION=${_VERSION},SHORT_SHA=${_SHORT_SHA}

timeout: 9000s
tags: ['deploy','${_ENV}','${_VERSION}','${_SHORT_SHA}']

options:
  dynamic_substitutions: true
